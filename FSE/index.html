<!DOCTYPE HTML>
<html>
    <head>
        <title>FastScriptEditor 1.0</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="./tables.js" type="text/javascript"></script>
    </head>
    <body>
        <p style="margin-top: 19px;">Starting Offset:</p>
        <input id="offset" type="text" style="position: absolute; top: 38px;" value="0x197D000"></input>
        <select style="position: absolute; top: 1px;">
            <option id="rse" value="1" selected>Ruby/Sapphire/Emerald</option>
            <option id="frlg" value="2">FireRed/LeafGreen</option>
        </select>
        <br>
        <br>
        <button id="convert_button" onclick="convert();" style="position: absolute; top: 75px;">Convert! (Ctrl+Q)</button>
        <button id="help-button" onclick="launchHelp();" style="position: absolute; top: 75px; left: 10%;">Documentation/Help</button>
        <br>
        <br>
        <p style="position: absolute; left: 10px; top: 90px;">FSE code (input)</p>
        <p style="position: absolute; left: 632px; top: 90px;">XSE code (output)</p>
        <textarea id="in" cols="85" rows="65" autocomplete="false" spellcheck="false"></textarea>
        <textarea id="out" cols="85" rows="65" readonly></textarea>
        <br>
        <p id = "status">Welcome to FSE. This message will tell you whether or not a conversion was successful.</p>
        <script>



var keysDown = [];

document.addEventListener("keyup", function(e) {

    delete keysDown[keysDown.indexOf(e.key)];

});

document.addEventListener("keydown", function(e) {

    keysDown.push(e.key);

    if (keysDown.indexOf("Control") > -1 && keysDown.indexOf("q") > -1) {
        convert();
    }

});

function launchHelp() {

	window.open("https://github.com/ps4star/FSE/blob/master/ref.md");

}



var noliNewLineAre = false;


function determineType(data) {
    if (data.indexOf("#raw") > -1) {
        return "#raw";
    } else if (data.charAt(0)+data.charAt(1) == "= ") {
        return "text";
    }
}


function calcBytes(dataType, data) {
    if (dataType == "#raw") {
        return data.split("\n").length;
    } else if (dataType == "text") {
        console.log(data);
        return data.length-2;
    }
}





var currOff = 0;

function getOff() {
	let ret = "@off"+currOff.toString();
	return ret;
}

function nextOff() {
	currOff++;
}


String.prototype.addOrg = function(data) {
    var toReturn = "#org "+getOff()+"\n"+data;
    nextOff();
    goff = parseInt(goff, 16);
    goff += calcBytes(determineType(data), data);
    goff++; //Adds the extra byte to avoid overwriting terminators
    if (determineType(data) == "text") {
        goff++; //padding for strings. may not be necessary.
    }
    goff = "0x"+goff.toString(16).toUpperCase();
    return toReturn+"\n\n";
}


var cSpeed = "normal";


function parseMoves(input) {

    if (whichGame == "rse") {
        var currentTable = rseMoveTable;
    } else {
        var currentTable = frlgmovetable;
    }

    var res = "";

    for(var i = 0; i < input.length; i++) {
        if (["up", "down", "left", "right"].indexOf(input[i]) > -1) {
            input[i] += cSpeed;
            console.log(input[i]);
        }
        res += "#raw "+currentTable[input[i]]+"\n";
    }
    return res+"#raw 0xFE";

}

function pokeToID(poke) {

    return pokemontable[poke.toLowerCase()];

}

function itemToID(item) {

    return itemstable[item.toLowerCase()];

}


var success = true;

var envr = new Object();
envr.autoobtain = true;
envr.autolock = true;



function toXSEhex(hexnum) {
    return "0x"+hexnum.toString(16).toUpperCase();
}

function getXSE(text) {
    var lines = (text+"\n").split(/\n/);
    var header = "#dynamic "+goff+"\n"+"#org "+goff+"\n\n";
    var body = "";
    var footer = "";

    if (envr.autolock) {
    	var lockReleaseText = "lock\nfaceplayer\n";
    } else {
    	var lockReleaseText = "";
    }

	//console.log(goff)
    for(var i = 0; i < lines.length; i++) {
        var cline = lines[i];

        if (cline.charAt(0) != ";") {
        var arg = cline.split(" ");

        console.log(lines);

        switch(arg[0].toLowerCase()) {
            case "applymovement":
            case "movement":
            case "mvmt":
            case "move":
            case "movenowait":
            case "movenowaitmovement":
            case "moven":
            case "moveno":
            case "movewait":
            case "movewithwait":
            case "movewithawait":
            case "movewithwaitmovement":
            case "movewithawaitmovement":
                body += "applymovement "+arg[1]+" "+goff;

                if (!(arg[0] == "movenowait" || arg[0] == "moven" || arg[0] == "moveno" || arg[0] == "movenowaitmovement")) {
                    body += "\nwaitmovement "+arg[1];
                }

                footer += footer.addOrg(parseMoves(arg.slice(2)));
                break;
            case "wrp":
            case "warp":
                body += "warp 0x"+parseInt(arg[1].split(".")[0], 16)+" 0x"+parseInt(arg[1].split(".")[1], 16)+" 0x"+parseInt(arg[1].split(".")[2], 16)+" 0x0 0x0";
                break;
            case "speed":
            case "movementspeed":
            case "setmovementspeed":
            case "setmovespeed":
            case "mvmtspeed":
            case "mvmtspd":
            case "movespeed":
            case "mspeed":
            case "movespd":
            case "setspeed":
                if (arg[1]+arg[2] == "veryslow" || arg[1] == "veryslow" || arg[1] == "vslow") {
                    if (whichGame == "rse") {
                        alert("The 'very slow' speed did not exist in R/S/E. Please change the game to FR/LG if you're working with that game, or adjust the speed to 'slow', 'normal', 'fast', 'faster', or 'fastest' if you're working with R/S/E.");
                        success = false;
                    } else {
                        cSpeed = "veryslow";
                    }
                } else {
                    cSpeed = arg[1];
                }
                noliNewLineAre = true;
                break;
            case "msgbox":
            case "msg":
            case "text":
            case "txt":
            case "filltext":
            case "domsgbox":
            case "message":
            case "messagebox":
            	let txtOff = getOff();
                body += "msgbox "+txtOff+" "+arg.slice(-1)[0];
                footer += footer.addOrg("= "+arg.slice(1, -1).join(" ")); //Adds our text data.
                break;
            case "setenvironmentvar":
            case "setenvironmentvariable":
            case "setenvr":
            case "setenviron":
            case "setenvironvar":
            case "environvar":
            case "environ":
            case "environment":
            case "envr":
                eval("envr."+arg[1]+" = "+arg.slice(2).join(" ")+";"); //Sets an envr var.
                if (arg[1] == "autolock" && eval(arg.slice(2).join(" "))) {
                	lockReleaseText = "lock\nfaceplayer\n"
                } else if (!eval(arg.slice(2).join(" "))) {
                	lockReleaseText = "";
                }
                noliNewLineAre = true;
                break;
            case "givepokemon":
            case "givepoke":
            case "gp":
            case "addpokemon":
            case "pokemongive":
            case "poke":
            case "pokemon":
                console.log("arg 1 init");
                console.log(arg[1]);
                if (!arg[1].includes("0x")) { //Checks if already in hex number format.
                    var oArg = arg[1];
                    arg[1] = pokeToID(arg[1].toLowerCase()); //If not, set it to the decimal pokemon ID.
                }
                if (!arg[1].includes("0x")) { //It can now be either a hex pokemon ID or decimal pokemon ID.
                    arg[1] = toXSEhex(parseInt(arg[1])); //So if it's still not a hex number, convert it from dec number to hex number.
                }
                console.log(arg[1]);
                //So now we have a hexidecimal pokemon identifier that meets XSE's standards.
                if (!arg[2].includes("0x")) { //Checks if the level is in hex already.
                    arg[2] = toXSEhex(parseInt(arg[2])); //If not, convert it to hex
                }
                //So now we have our pokemon identifier and our hex level value.
                arg[3] = arg.slice(3).join(" ");
                if (!arg[3].includes("0x")) { //Checks if the held item is in hex already.
                    arg[3] = itemToID(arg[3].toLowerCase()); //If not, set it to the item ID from the item name.
                }
                if (!arg[3].includes("0x")) { //Checks if it's now not a hex number.
                    arg[3] = toXSEhex(parseInt(arg[3])); //If not, make it one.
                }
                //So now we have our pokemon ID in hex, a level in hex, and an item ID in hex.
                //But first we need to set up the 6+ pokemon check.
                body += "givepokemon "+arg[1]+" "+arg[2]+" "+arg[3]+" 0x0 0x0 0x0";

                if (envr.autoobtain) {
                    body += "\nfanfare 0x13E\nmsgbox "+goff+" 0x4";
                    footer += footer.addOrg("= You received a "+oArg.charAt(0).toUpperCase()+oArg.substr(1).toLowerCase()+"!");
                }

                break;
            default:
                body += arg.join(" ");
                console.log("DEFAULT HERE");
                break;
        }
        
        if (!noliNewLineAre) {
            body += "\n";
        }
        noliNewLineAre = false;

        }

    }

    return header+lockReleaseText+body+"end\n\n"+footer;
}










function calcProgramBytes(text) {

    var lines = (text+"\n").split(/\n/);
    var bytesToOffset = 0;

    for(var i = 0; i < lines.length; i++) {
		var cline = lines[i];
        if (cline.charAt(0) != ";") {
        var arg = cline.split(" ");

        switch(arg[0].toLowerCase()) {
            case "applymovement":
            case "movement":
            case "mvmt":
            case "move":
            case "movenowait":
            case "movenowaitmovement":
            case "moven":
            case "moveno":
            case "movewait":
            case "movewithwait":
            case "movewithawait":
            case "movewithwaitmovement":
            case "movewithawaitmovement":
                bytesToOffset += arg.length;
                break;
            case "wrp":
            case "warp":
                bytesToOffset += 6;
                break;
            case "msgbox":
            case "msg":
            case "text":
            case "txt":
            case "filltext":
            case "domsgbox":
            case "message":
            case "messagebox":
                bytesToOffset += arg.slice(1).join(" ").length;
                break;
            case "givepokemon":
            case "givepoke":
            case "gp":
            case "addpokemon":
            case "pokemongive":
            case "poke":
            case "pokemon":
                if (text.includes("autoobtain false")) {
                    bytesToOffset += arg.length;
                }
                bytesToOffset += arg.length;
                break;
            default:
                bytesToOffset += arg.length+2;
                break;
        }
        }

    }

	return bytesToOffset;

}










var goff = document.getElementById("offset").value;
var whichGame = "rse";

var inbutton = document.getElementById("in");

if (localStorage["inputdata"] != "undefined" && localStorage["inputdata"] != undefined && localStorage["inputdata"] != null) {
    inbutton.value = localStorage["inputdata"];
}

function resetAll() {
	currOff = 0;
}


function convert() {
    var inbutton = document.getElementById("in");
    var outbutton = document.getElementById("out");

    var rse = document.getElementById("rse").selected;
    var frlg = document.getElementById("frlg").selected;

    goff = document.getElementById("offset").value;
    var stat = document.getElementById("status");

    if (rse) {
        whichGame = "rse";
    } else {
        whichGame = "frlg";
    }

    var intext = inbutton.value.replace("_", "").replace("-", "");
    localStorage["inputdata"] = inbutton.value;

    var res = getXSE(intext);

    if (success) {
        outbutton.innerHTML = res;

        outbutton.select();
        document.execCommand("copy");
        window.getSelection().removeAllRanges();
        
        stat.innerHTML = "Conversion successful. Output data copied to clipboard.";
    } else {
        stat.innerHTML = "Conversion unsuccessful. An alert box should have explained the error.";
        success = true;
    }

    resetAll();

}






















        </script>
    </body>
</html>
